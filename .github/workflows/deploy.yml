name: Deploy to Server

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run tests
      run: |
        python -m pytest tests/ -v || echo "No tests found, continuing..."

    - name: Lint Python code
      run: |
        python -m flake8 --max-line-length=100 --ignore=E501,W503 *.py || echo "Linting completed with warnings"

    - name: Check deployment secrets
      if: github.ref == 'refs/heads/main'
      run: |
        echo "üîç Checking deployment configuration..."
        
        MISSING_SECRETS=false
        
        if [ -z "${{ secrets.SERVER_HOST }}" ]; then
          echo "‚ùå SERVER_HOST secret is not configured"
          MISSING_SECRETS=true
        else
          echo "‚úÖ SERVER_HOST is configured"
        fi
        
        if [ -z "${{ secrets.SERVER_USER }}" ]; then
          echo "‚ùå SERVER_USER secret is not configured"
          MISSING_SECRETS=true
        else
          echo "‚úÖ SERVER_USER is configured"
        fi
        
        if [ -z "${{ secrets.SERVER_SSH_KEY }}" ]; then
          echo "‚ùå SERVER_SSH_KEY secret is not configured"
          MISSING_SECRETS=true
        else
          echo "‚úÖ SERVER_SSH_KEY is configured"
        fi
        
        if [ "$MISSING_SECRETS" = "true" ]; then
          echo ""
          echo "üö® Deployment cannot proceed due to missing secrets!"
          echo "Please configure the following secrets in your GitHub repository:"
          echo "Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí New repository secret"
          echo ""
          echo "Required secrets:"
          echo "- SERVER_HOST: The IP address or hostname of your deployment server"
          echo "- SERVER_USER: SSH username for the deployment server (e.g., ubuntu, root, or your username)"
          echo "- SERVER_SSH_KEY: Private SSH key for authentication (contents of ~/.ssh/id_rsa or similar)"
          echo ""
          echo "Optional secrets:"
          echo "- SERVER_PORT: SSH port (defaults to 22 if not specified)"
          echo "- DEPLOY_PATH: Deployment directory path (defaults to /home/thecroxdevil/jellyfin-setup)"
          echo "- SLACK_WEBHOOK_URL: Webhook URL for deployment notifications"
          echo ""
          echo "For more information, see the deployment documentation in the repository."
          exit 1
        fi
        
        echo "‚úÖ All required deployment secrets are configured"

    - name: Deploy to server
      if: github.ref == 'refs/heads/main'
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT || '22' }}
        script: |
          set -e
          echo "üöÄ Starting deployment..."
          
          # Navigate to deployment directory
          cd ${{ secrets.DEPLOY_PATH || '/home/thecroxdevil/jellyfin-setup' }}
          
          # Backup current configuration
          echo "üì¶ Creating backup..."
          sudo cp docker-compose.yml docker-compose.yml.backup.$(date +%Y%m%d_%H%M%S) || true
          
          # Pull latest changes
          echo "üì• Pulling latest changes..."
          git fetch origin
          git reset --hard origin/main
          
          # Install/update Python dependencies
          echo "üêç Installing Python dependencies..."
          python3 -m pip install --user -r requirements.txt || echo "Failed to install some dependencies, continuing..."
          
          # Create required directories
          echo "üìÅ Creating required directories..."
          mkdir -p media/{movies,tv,music,photos} jellyfin_config xteve_config npm_data letsencrypt
          
          # Set permissions
          echo "üîê Setting permissions..."
          sudo chown -R $USER:$USER . || true
          chmod +x scripts/*.sh || true
          
          # Run any pre-deployment scripts
          echo "üîß Running pre-deployment tasks..."
          if [ -f scripts/pre-deploy.sh ]; then
            bash scripts/pre-deploy.sh
          fi
          
          # Stop existing containers
          echo "‚èπÔ∏è Stopping existing containers..."
          docker-compose down || echo "No containers to stop"
          
          # Pull latest images
          echo "üì¶ Pulling latest Docker images..."
          docker-compose pull
          
          # Start services
          echo "‚ñ∂Ô∏è Starting services..."
          docker-compose up -d
          
          # Wait for services to be ready
          echo "‚è≥ Waiting for services to be ready..."
          sleep 30
          
          # Health check
          echo "üè• Running health checks..."
          bash scripts/health-check.sh || echo "Health check failed, but continuing..."
          
          # Run post-deployment scripts
          echo "‚úÖ Running post-deployment tasks..."
          if [ -f scripts/post-deploy.sh ]; then
            bash scripts/post-deploy.sh
          fi
          
          echo "üéâ Deployment completed successfully!"
          
          # Show container status
          echo "üìä Container status:"
          docker-compose ps

    - name: Notify deployment status
      if: always()
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
